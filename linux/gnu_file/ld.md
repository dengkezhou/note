## 链接

链接过程:将一系列目标文件映射为一个可执行文件，并定义了输出文件的内存布局。

链接脚本: 控制链接的过程，指定输入、输出段的合并、属性等。

### 一 概述

链接器ld将一个或多个输入文件(obj文件)合并为一个输出文件(可执行文件)。所有的文件都可以称作目标文件，每个目标文件都有一个段section列表，称作输入段或输出段。

每个段都有名称和大小，大多数还具有关联的数据块(段内容)。

每个可加载或可分配的输出段都有两个地址: 虚拟内存地址VMA，加载内存地址LMA。大多数情况下两个地址是相同的，不同时的一个例子是在加载时将数据段加载到ROM中，在程序运行时将其复制到RAM中运行。

```C
// 使用 > 命令指定运行地址（vma）在RAM中，使用 AT > 命令指定加载地址在FLASH中。
// vma 与 lma不同是为了使程序的存储位置和运行位置区分开来。
.text : { 
	*(.text)
} > RAM AT > FLASH
```

可以使用objdump -h 查看目标文件中段的各个部分.

链接时使用 -T file.ld 指定链接脚本。

### 二、链接脚本语法

#### 2.1 格式

链接脚本是文本文件。

一个链接脚本是一系列的命令，每个命令都是一个关键字。

使用分号分割命令。

使用 /*  */注释。

链接脚本中引用的文件名、段名等包含 “;”等分割符的，需要使用双引号将全称包含起来。

#### 2.2 关键字

**ENTRY**

设置入口点，即程序的第一条指令。

```c
/* 参数是符号的名称。*/
ENTRY (symbol)
```

有多种设置入口点的方法，链接器将依次尝试以下方法来设置入口点，并在一种成功后停止。

‘‘-e’’选项设置

链接脚本ENTRY设置

目标专用符号值(如果已定义),大多数情况下是_start

.text段的第一个字节的位置

地址0

**SECTIONS**

描述输出文件的内存布局，格式为

```
SECTIONS
{
...
	secname : { contents }
...
}
```

secname 表示输出段名，后面必须有一个空格符，使得输出段名不会有歧义，后面跟冒号和大括号。

contents 描述一套规则和条件，表示符合条件的输入段被合并到这个输出段中。

contents规则

```c
//格式
filename(sections)
// 如
file1.o(.data, .rodata)  //file1.o的.data 和 .rodata段。段之间以空格或逗号隔开。
file1.o     // file1的所有段
*(.data)    // 所有输入文件的.datat 段,“*”为通配符
//[]规则，[a-z]表示字母a-z，则下面的contents表示以a到z开头的输入文件中以.text开头,A-Z结尾的段。
[a-z]*(.text*[A-Z])
```

假设程序仅包含代码、初始化数据和未初始化数据，分别位于 .text、.data 、.bss段中，代码段加载地址为0x10000，数据段加载地址为 0x80000000，则链接脚本为：

```c
SECTIONS
{
  . = 0x10000;   
  .text : { *(.text)}
  . = 0x8000000;
  .data : { *(.data) }
  .bss : { *(.bss) }
  /DISCARD/ : {*(.commont)}
}
```

第一行设置特殊符号 "."的值，即位置计数器，表示**当前的虚拟地址**。在SECTIONS的开头，位置计数器为0，设置一个段后，计数器的位置会增加段的大小。

/DISCARD/ 特殊的输出段名，意为丢弃，comment段将不保存在输出文件中。

 **MEMORY**

连接器的默认配置允许所有可用内存，可以使用MEMORY命令进行重载，memory配置的内存都属于虚拟内存。

MEMORY命令描述目标中内存块的位置和大小，链接器会基于内存区域设置段地址，如果区域区域饱和将会产生警告信息。

链接器不会为了把段更好的放入内存区域而打乱段的顺序。

```c
MEMORY
{
    name [(attr)] : ORIGIN = origin, LENGTH = len
    rom (irx!wa)  : ORIGIN = 0x80200000, LENGTH = 0x10000000
    …
}
/*
name：  名称,存储在单独的名称空间中，不会与符号名、段名等冲突，在链接器脚本之外没有意义。
arrt：  段属性 R-只读段  W-读写段 X-可执行段 A-可分配段 I-已初始化段 !-反转其后所有的属性
       如过一个未映射的段匹配了attr中的属性，则该段会被映射到该内存区域。
ORIGIN: 内存区域的起始地址，必须是常量表达式
LENGTH: 内存区域的字节大小，必须是常量表达式
    可以通过 ORIGIN(memory) 和 LENGTH(memory) 函数获得内存区域的起始地址以及长度：
*/

/* 一般在设置段时，规定段位于的memory，而不匹配段属性，段属性值可以省略*/
SECTIONS
{
    . = ALIGN(4);
    .text : {
     	*(.text*)
    } > rom
}
```

#### 2.3 符号

在链接脚本中定义的符号，具有全局属性，位于具有全局作用域的符号表中。

定义符号时需要同时初始化，符号的赋值和定义具有相同的语法格式。

**使用c操作符定义符号**

```
symbol = expression;
+= *= << >> ......
```

**HIDDEN**定义一个符号，该符号被隐藏不会导出。

```
HIDDEN(symbol = expression );
```

**PROVIDE**定义一个符号，当该符号被引用且没有其他定义时生效

```
PROVIDE(symbol = expression );
```

#### 其他关键字命令

下列命令功能很多在cmd命令上指定

| 命令语句               | 说明                               |
| ---------------------- | ---------------------------------- |
| STARTUP(filename)      | 将文件filename作为第一个输入文件   |
| SEARCH_DIR(path)       | 添加查找库路径，同-Lpath           |
| INPUT(file1, file2...) | 将指定文件作为链接过程中的输入文件 |
|                        |                                    |

### 三、ld命令行参数

使用ld --help 查看ld的参数

格式 ld [option] 文件 ...

| 选项                                   | 功能                                     |
| -------------------------------------- | ---------------------------------------- |
| -A   target 或   --architecture target | 设置cpu架构                              |
| -e addr  或 --entry addr               | 设置入口地址（函数）                     |
| -o file                                | 设置输出文件名                           |
| -s 或 --strip-all                      | 剔除所有符号信息                         |
| -S 或 --strip-debug                    | 剔除调试符号信息                         |
| -T file   或 --script file             | 指定链接脚本，不设置时使用默认链接脚本   |
| -Bstatic, -dn, -non_shared, -static    | 静态链接                                 |
| -Bdynamic, -dy, -call_shared           | 动态链接                                 |
| -Map file                              | 输出一个链接图文件                       |
| -rpath path                            | 设置运行时共享库的搜索路径，一般不要使用 |
| -pie, --pic-executable                 | 生成位置无关的可执行文件                 |
| -Tbss addr, -Tdata addr,  -Ttext addr  | 设置bss段、data段、text段的起始地址      |

